<html>
<head>
  <meta name="description" content="EFHTEST">
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>EFHTEST</title>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 97.5%;
      width: 100%;
    }
    #header {
      padding-top: 5px;
      padding-bottom: 5px;
      margin: auto;
      height: 40px;
      width: 100%;
      background-color: #00467F;
      text-align: center;
    }
   .dropbtn {
     background-color: #00467F;
     color: white;
     padding: 9px;
     font-size: 16px;
     font-family:'verdana';
     border: none;
     cursor: pointer;
  }

  .dropbtn:hover, .dropbtn:focus {
     background-color: #00067F;
  }

  .dropdown {
     float: right;
     position: relative;
     display: inline-block;
  }

  .about-content {
     display: none;
     position: absolute;
     right: 0;
     background-color: #f1f1f1;
     border-style: solid;
     border-width: 1px;
     border-color: black;
     min-width: 350px;
     overflow: auto;
     box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
     z-index: 1;
     font-family:'verdana';
     font-size: 13px;
     padding: 5px;

  }
  .show {display: block;}
  </style>
  <link rel="stylesheet" href="https://js.arcgis.com/4.15/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.15/"></script>
</head>

<script>
  require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/widgets/Search",
      "esri/tasks/Locator",
      "esri/widgets/BasemapToggle",
      "esri/widgets/Popup",
      "esri/views/draw/PolygonDrawAction",
      "esri/views/draw/Draw"
    ],
    function(
      Map, MapView, FeatureLayer, GraphicsLayer, Graphic, Search, Locator, BasemapToggle, Popup, PolygonDrawAction, Draw) {
      
      //base map set to topography
      var map = new Map({
        basemap: "topo-vector"
      });

      //Create the map view
      var view = new MapView({
        container: "viewDiv", //set it to the html division
        map: map,
        center: [-94.82100,29.55100], //View centered on Galvestion/Houston
        zoom: 8, //Just a good zoom factor for the Texas coast
        popup: {
            dockEnabled: true,
            dockOptions: {
              // Disables the dock button from the popup
              buttonEnabled: false,
              // Ignore the default sizes that trigger responsive docking
              breakpoint: false
            }
          },
      });
      //A draw constructor for drawing the project area polygon
      const draw = new Draw({
          view: view
      });
    
      //Addition of widget toggling the basemap from topography to satellite view
      var basemapToggle = new BasemapToggle({
        view: view,
        nextBasemap: "hybrid"
      });
      view.ui.add(basemapToggle, "bottom-right"); //Set to the bottom right
    
      //Addition of the search widget to allow it to search lat/longs and current location for querying
      var searchWidget = new Search ({ 
        view: view,
        includeDefaultSources: false, //Remove the usual search sources
        popupEnabled: false, //Keep the search from popping up its own results
        resultGraphicEnabled: false, //No need to offer possible results
        sources: [{//This is the source that allows for querying lat/long
              locator: new Locator({ url: "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer" }),
              placeholder: "Enter Lat/Long",
              singleLineFieldName: "SingleLine",
              outFields: ["Address"],
              name: "ArcGIS World Geocoding Service",
              suggestionsEnabled: false,
              
            }],
        locationEnabled: true
      });
      view.ui.add(searchWidget, "top-right");//Set the search to the top right
    
      //Addition of the button found on the query results window that pops up, used for downloading a CSV file
      var downloadReportAction = {
          title: "Download CSV",
          id: "downloadReport",
          image: "https://umiami.maps.arcgis.com/sharing/rest/content/items/f2676983a0ed4e769e2e09ab7bf0b8eb/data" //Image for the download button hosted from ArcGIS
      };

      //Query results window added with no information
      var infoWindow = new Popup ({
        view: view,
        actions: [downloadReportAction]//Add the download button
      });
      view.ui.add(infoWindow);//Adds the info window to the view, but visibility is controlled by the querying
      
      //The line button is constructed in the html, but set in the view here.
      view.ui.add("line-button", "top-left");
    
     //Load in the feature layers used for querying habitat/species parameter
      var GulfLayer = new FeatureLayer ({
        url: "https://services1.arcgis.com/B4MnusZHL3vmqU3t/arcgis/rest/services/ccap_2016_GulfCoast_WGS_salinityclip/FeatureServer"
      });
      var SAtlanticLayer =  new FeatureLayer ({
        url: "https://services1.arcgis.com/B4MnusZHL3vmqU3t/arcgis/rest/services/ccap_2016_SAtlantic_WGS_salinitycl/FeatureServer"
      });
      var parameterTable = new FeatureLayer ({
        url: "https://services1.arcgis.com/B4MnusZHL3vmqU3t/arcgis/rest/services/EFHQueryTable/FeatureServer"
      }); 

    
      var habitat; //A variable that holds the habitat grid code for querying
      var reportText; //The information that returned in the downloaded report
      var queryPolygon = false; //Used to determine whether querying a polygon project area
      var stateRow = null; //Used to hold the state results of the query
      var drawing = false; //Used to determine whether the user is currently drawing
      var councilName;
    
    function queryTable(){
        var name = []; //Array holding species common names
        var windowText = []; //Text to display on the pop up info window
        reportText = ["Species,common_name,Life_stage,salinity_low,salinity_high,depth_low,depth_high,comments"
];//Populate the report text with column headers
       
       //Switch case for the queried habitat grid codes, depending on the habitat, the queried salinity high and low changes
       switch(habitat){
         case 13: //Palustrine Forested Wetland
           console.log("Case 13");
           var tableQuery = {
            outFields: ["*"],
            where: "(salinity_low <= 4) AND (salinity_high >= 0) AND (" + stateRow + " = 'Y')"
           }
           habitat = 0;
           break;
         case 14: //Palustrine Scrub/Scrub Wetland
           console.log("Case 14");
           var tableQuery = {
            outFields: ["*"],
            where: "(salinity_low <= 4) AND (salinity_high >= 0) AND (" + stateRow + " = 'Y')"
           }
           habitat = 0;
           break;
         case 15: //Palustrine Emergent Wetland
           console.log("Case 15");
           var tableQuery = {
            outFields: ["*"],
            where: "(salinity_low <= 4) AND (salinity_high >= 0) AND (" + stateRow + " = 'Y')"
           }
           habitat = 0;
           break;
         case 16: //Estuarine Forested Wetland
           console.log("Case 16");
           var tableQuery = {
            outFields: ["*"],
            where: "(salinity_low <= 38) AND (salinity_high >= 5) AND (" + stateRow + " = 'Y')"
           }
           habitat = 0;
           break;
         case 17: //Estuarine Scrub/Scrub Wetland
           console.log("Case 17");
           var tableQuery = {
            outFields: ["*"],
            where: "(salinity_low <= 38) AND (salinity_high >= 5) AND (" + stateRow + " = 'Y')"
           }
           habitat = 0;
           break;
         case 18: //Estuarine Emergent Wetland
           console.log("Case 18");
           var tableQuery = {
            outFields: ["*"],
            where: "(salinity_low <= 38) AND (salinity_high >= 5) AND (" + stateRow + " = 'Y')"
           }
           habitat = 0;
           break;
         case 19: //Unconsolidated Shore
           console.log("Case 19");
           var tableQuery = {
            outFields: ["*"],
            where: "(" + stateRow + " = 'Y')"
           }
           habitat = 0;
           break;
         case 21: //Open Water
           console.log("Case 21");
           var tableQuery = {
            outFields: ["*"],
            where: "(" + stateRow + " = 'Y')"
           }
           habitat = 0;
           break;
         case 22: //Palustrine Aquatic Bed
           console.log("Case 22");
           var tableQuery = {
            outFields: ["*"],
            where: "(salinity_low <= 4) AND (salinity_high >= 0) AND (" + stateRow + " = 'Y')"
           }
           habitat = 0;
           break;
         case 23: //Estuarine Aquatic Bed
           console.log("Case 23");
           var tableQuery = {
            outFields: ["*"],
            where: "(salinity_low <= 38) AND (salinity_high >= 5) AND (" + stateRow + " = 'Y')"
           }
           habitat = 0;
           break;
         default: //If the area has no discernable habitat,
           console.log("Default")
           var tableQuery = {
            outFields: ["*"],
            where: "'common_name' = 'Nothing'"
           }
       }
          //Query species parameter table using the query generated by the switch case
      console.log(tableQuery);
          parameterTable.queryFeatures(tableQuery).then(function(result) {
                  windowText.push("<p>An essential fishery habitat was found within the" + councilName + " fishery management zone. A list of species is shown below. To view further information on life stages, depth ranges, and comments, please use the Download CSV button below to receive a table of information.</p>");
                  result.features.forEach(function(feature){
                    if(feature.attributes.common_name != name[name.length-1]){
                      name.push(feature.attributes.common_name);
                      windowText.push("<li><b>"+feature.attributes.common_name+"</b></li>");
                    }
                    reportText.push(feature.attributes.Species+","+feature.attributes.common_name+","+feature.attributes.life_stage+","+feature.attributes.salinity_low+","+feature.attributes.salinity_high+","+feature.attributes.depth_low+","+feature.attributes.depth_high+","+feature.attributes.comments);
                  });
              
                 if(name[0] != null) {
                      infoWindow.title = "EFH Species Found:";
                      infoWindow.content = windowText.join(""); 
                      infoWindow.actions = [downloadReportAction];
                      infoWindow.visible = true;
                 }
                 else{
                   if(infoWindow.location.longitude.toFixed(4) > -82){
                      infoWindow.title = "No EFH Consultation Necessary";
                      infoWindow.content = "There are a few reasons why an EFH may have not been found here: <li>The habitat may not be suitable to facilitate any EFH species' life stage.</li><li>The depth may not be suitable to facilitate any EFH species' life stage.</li><li>This area may be out of range of this state's designation for EFH species.</li><li>Contact your local EFH coordinator for more information.</li>"; 
                      infoWindow.actions = [];
                   }
                   else{
                      infoWindow.title = "No EFH Consultation Necessary";
                      infoWindow.content = "There are a few reasons why an EFH may have not been found here: <li>The habitat may not be suitable to facilitate any EFH species' life stage.</li><li>The depth may not be suitable to facilitate any EFH species' life stage.</li><li>This area may be out of range of this state's designation for EFH species.</li>"; 
                      infoWindow.actions = [];
                   }
                 }
            queryPolygon = false;
           });
        return true;
      }
    
    function queryFeatureLayerView(shape, spatialRelationship, sqlExpression){
        infoWindow.title = "Searching for an EFH";
        infoWindow.content = "Please wait a moment..."; 
        infoWindow.actions = [];
        councilName = "";
       
        console.log(shape);
        if (!map.findLayerById(GulfLayer.id)) {
          GulfLayer.outFields = ["*"];
        }
        if (!map.findLayerById(SAtlanticLayer.id)) {
          SAtlanticLayer.outFields = ["*"];
        }
        var habitatQuery = {
          geometry: shape,
          distance: 30,
          units: "meters",
          spatialRelationship: spatialRelationship,
          outFields: ["*"],
          returnGeometry: false,
          where: sqlExpression
        }; 
        GulfLayer.queryFeatures(habitatQuery).then(function(result) {
                    result.features.forEach(function(feature){
                      councilName = "Gulf";
                      if(feature.attributes.gridcode > 15 || feature.attributes.gridcode != 22){
                          habitat = feature.attributes.gridcode;
                          //console.log("Habitat" + feature.attributes.gridcode);
                      }
                      else{
                          habitat = feature.attributes.gridcode;
                          //console.log("Habitat" + feature.attributes.gridcode);
                      }
                      
                      stateRow = feature.attributes.State;
                    }); 
                    SAtlanticLayer.queryFeatures(habitatQuery).then(function(result) {
                            result.features.forEach(function(feature){
                              if(councilName = "Gulf"){
                                councilName = "both the Gulf and South Atlantic";
                              }
                              else{
                                councilName = "South Atlantic";
                              }
                              if(feature.attributes.gridcode > 15 || feature.attributes.gridcode != 22){
                                  habitat = feature.attributes.gridcode;
                                  
                              }
                              else{
                                  habitat = feature.attributes.gridcode;
                          
                              }
                      
                              stateRow = feature.attributes.State;
                            });
                      console.log("habitat: " + habitat);
                      queryTable();
                    });      
        });
      return true;
      }
    
    function createPolygonGraphic(vertices, polyComplete){
      view.graphics.removeAll();
      var polygon = {
        type: "polygon", // autocasts as Polygon
        rings: vertices,
        spatialReference: view.spatialReference
      };

      var graphic = new Graphic({
        geometry: polygon,
        symbol: {
          type: "simple-fill", // autocasts as SimpleFillSymbol
          color: [15, 15, 128, 0.5],
          style: "solid",
          outline: {  // autocasts as SimpleLineSymbol
            color: "black",
            width: 1
          }
        }
      });
      view.graphics.add(graphic);
      if(polyComplete){
        infoWindow.visible = true;
        queryFeatureLayerView(polygon, "intersects");
        drawing = false;
        document.getElementById("line-button").className = "esri-widget esri-widget--button esri-icon-polygon esri-interactive";
        view.ui.add("line-button", "top-left");
      }
    }
    
    function enableCreatePolygon(draw, view) {
      var action = draw.create("polygon");
      // PolygonDrawAction.vertex-add
      // Fires when user clicks, or presses the "F" key.
      // Can also be triggered when the "R" key is pressed to redo.
      action.on("vertex-add", function (evt) {
        createPolygonGraphic(evt.vertices, false);
      });

      // PolygonDrawAction.vertex-remove
      // Fires when the "Z" key is pressed to undo the last added vertex
      action.on("vertex-remove", function (evt) {
        createPolygonGraphic(evt.vertices, false);
      });

      // Fires when the pointer moves over the view
      action.on("cursor-update", function (evt) {
        createPolygonGraphic(evt.vertices, false);
      });

      // Add a graphic representing the completed polygon
      // when user double-clicks on the view or presses the "C" key
      action.on("draw-complete", function (evt) {
        createPolygonGraphic(evt.vertices, true);
      });
    }
    
     
      
     function downloadReport() {
        var reportFile = document.createElement('a');
        reportFile.setAttribute('href', 'data:text/plain;charset=utf-8,' +  encodeURIComponent(reportText.join("\n")));
        reportFile.setAttribute('download', "test.csv");

        reportFile.style.display = 'none';
        reportFile.click();
      }

      view.on("click", function(event){
        
        infoWindow.location = event.mapPoint;
        if(!queryPolygon){
          view.graphics.removeAll();
          if(queryFeatureLayerView(event.mapPoint, "intersects")){
             infoWindow.visible = true;
             searchWidget.searchTerm = event.mapPoint.latitude.toFixed(4) + ", " + event.mapPoint.longitude.toFixed(4);
          }
          else{
             infoWindow.visible = false;
          }
        }
        
      });
    
      searchWidget.on("search-start", function(){
        infoWindow.visible = false;
        if(!queryPolygon){
          view.graphics.removeAll();
          searchWidget.goToOverride = function(view, goToParams) {
              goToParams.target.zoom = 8;
              goToParams.options.durations = 0;
              console.log(goToParams)
              queryFeatureLayerView(goToParams.target.target.center, "intersects");
              queryTable();
              infoWindow.location = goToParams.target.target.center;
              return view.goTo(goToParams.target, goToParams.options);     
          };
          console.log(searchWidget.searchTerm);
          console.log(view.viewpoint.targetGeometry);
          queryTable();
          infoWindow.visible = true;
        }
      });
    
      infoWindow.on("trigger-action", function (event) {
          if (event.action.id === "downloadReport") {
            console.log("Hello");
            downloadReport();
          }
      });


    document.getElementById("line-button").onclick = function () {
          view.graphics.removeAll();
          if(!drawing){
            document.getElementById("line-button").className = "esri-widget esri-widget--button esri-icon-close esri-interactive";
            view.ui.add("line-button", "top-left");
            infoWindow.visible = false;
            // creates and returns an instance of PolyLineDrawAction
            const action = draw.create("polyline");
            queryPolygon = true;
            enableCreatePolygon(draw, view)
            drawing = true;
          }
          else{
            document.getElementById("line-button").className = "esri-widget esri-widget--button esri-icon-polygon esri-interactive";
            view.ui.add("line-button", "top-left");
            queryPolygon = false;
            draw.reset();
            drawing = false;
          }
    };
      
    });
    
  </script>
</head>
<body>
  <div id="header">
    <t style="color:white; font-family:'verdana'; font-size: 190%;" > 
       Inland Test Mapper 
    </t>
    <div class="dropdown">
      <button onclick="dropDownFunction()" class="dropbtn">About</button>
      <div id="aboutMenu" class="about-content">
        <p align = "center" >The Inland EFH Mapper informs users of potential essential fishery habitats (EFHs), displaying the species and their lifestages at a provided coordinate.</p>
        <p align = "center" >The mapping tool responds to two styles of input:
        <li align = "center" >By clicking/touching your specific area of interest.</li>
        <li align = "center" >Entering in a "latitude, longitude" or current location in the search.</li>
        <li align = "center" >By clicking the draw icon on the top left of the map, you can draw a polygon representing your project area. Simply start the polygon by click somewhere on the map, and continue adding points until you have covered your project area. Double click to finish your area. The project area will disappear once you click somewhere on the map or click the draw icon again.</li></p>
         <p align = "center" >You will see a window pop up on the map explaining whether an EFH was found, followed by species common name and their life stages.
        </p>
        <p align = "center" >A CSV is available to download for your point of interest by clicking the "Download CSV" button located at the bottom left of the results window pop up. This CSV will include the resulting species, scientific names, life stages, minimum and maximum depth and salinity, and states where they are commonly found.</p>
        <p align = "center" >For more information on offshore EFH designations, or visible EFH boundaries, please visit the NOAA EFH Mapper tool (Link here).</p>
      </div>
    </div>
    <script>
    //Toggles showing the content of the instructional menu
    function dropDownFunction() {
      document.getElementById("aboutMenu").classList.toggle("show");
    }

    // Close the dropdown if the user clicks outside of it
    window.onclick = function(event) {
      if (!event.target.matches('.dropbtn')) {
        var dropdowns = document.getElementsByClassName("about-content");
        var i;
        for (i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
          }
        }
      }
    }
    </script>
  </div>
  <div id="viewDiv">
    <div
        id="line-button"
        class="esri-widget esri-widget--button esri-icon-polygon esri-interactive"
        title="Draw polygon"
      > 
      </div>
  </div>
  
</body>

</html>
